<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- ================================================================== -->
        <!-- NOTE: Sequences removed - Reference is now generated in Python code
             Format: SHIFT-YYMMDDXX or EOD-YYMMDDXX
             XX = shift_number (2 digits)
        -->
        <!-- ================================================================== -->

        <!-- ================================================================== -->
        <!-- ACTIONS (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô Views) -->
        <!-- ================================================================== -->

        <!-- Action to view deposits from audit -->
        <record id="action_gas_station_shift_audit_deposits" model="ir.actions.act_window">
            <field name="name">Related Deposits</field>
            <field name="res_model">gas.station.cash.deposit</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('audit_id', '=', active_id)]</field>
            <field name="context">{'default_audit_id': active_id}</field>
        </record>

        <!-- Action to view shifts in EOD period -->
        <record id="action_gas_station_shift_audit_shifts" model="ir.actions.act_window">
            <field name="name">Shifts in Period</field>
            <field name="res_model">gas.station.shift.audit</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('parent_eod_id', '=', active_id)]</field>
        </record>

        <!-- Main Action -->
        <record id="action_gas_station_shift_audit" model="ir.actions.act_window">
            <field name="name">Shift Audits</field>
            <field name="res_model">gas.station.shift.audit</field>
            <field name="view_mode">tree,form,pivot,graph</field>
            <field name="context">{'search_default_filter_today': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No shift audits yet
                </p>
                <p>
                    Shift audits are automatically created when Close Shift or End of Day is triggered from POS.
                </p>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- TREE VIEW - Set different color for EOD -->
        <!-- ================================================================== -->

        <record id="view_gas_station_shift_audit_tree" model="ir.ui.view">
            <field name="name">gas.station.shift.audit.tree</field>
            <field name="model">gas.station.shift.audit</field>
            <field name="arch" type="xml">
                <tree string="Shift Audits"
                    import="false"
                    duplicate="false"
                    decoration-info="state == 'draft' and audit_type == 'close_shift'"
                    decoration-warning="audit_type == 'end_of_day'"
                    decoration-success="state == 'reconciled'"
                    decoration-danger="state == 'discrepancy'">
                    
                    <!-- Main columns -->
                    <field name="name" string="Reference" />
                    <field name="shift_number" string="Shift #" />
                    <field name="close_time" string="Close Time" />
                    
                    <!-- Type badge - EOD ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏° -->
                    <field name="audit_type" string="Type" widget="badge"
                        decoration-info="audit_type == 'close_shift'"
                        decoration-warning="audit_type == 'end_of_day'" />
                    
                    <!-- EOD indicator -->
                    <field name="is_last_shift" string="EOD" widget="boolean" />
                    
                    <field name="staff_external_id" string="Staff" />
                    
                    <!-- Totals -->
                    <field name="total_all_deposits" string="Shift Total" widget="monetary"
                        options="{'currency_field': 'currency_id'}" sum="Total" />
                    <field name="pos_total_amount" string="POS Total" widget="monetary"
                        options="{'currency_field': 'currency_id'}" optional="show" />
                    
                    <!-- EOD specific columns -->
                    <field name="eod_grand_total" string="Day Total" widget="monetary"
                        options="{'currency_field': 'currency_id'}"
                        decoration-bf="audit_type == 'end_of_day'"
                        optional="show" />
                    <field name="collected_amount" string="Collected" widget="monetary"
                        options="{'currency_field': 'currency_id'}"
                        optional="hide" />
                    
                    <field name="total_deposit_count" string="# Txn" />
                    
                    <!-- State badge -->
                    <field name="state" string="Status" widget="badge"
                        decoration-info="state == 'draft'"
                        decoration-success="state in ('confirmed', 'reconciled')"
                        decoration-danger="state == 'discrepancy'" />
                    
                    <field name="currency_id" column_invisible="1" />
                </tree>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- FORM VIEW -->
        <!-- ================================================================== -->

        <record id="view_gas_station_shift_audit_form" model="ir.ui.view">
            <field name="name">gas.station.shift.audit.form</field>
            <field name="model">gas.station.shift.audit</field>
            <field name="arch" type="xml">
                <form string="Shift Audit" duplicate="false">
                    <header>
                        <button name="action_confirm" string="Confirm" type="object"
                            class="btn-primary"
                            invisible="state != 'draft'" />
                        <button name="action_reconcile" string="Reconcile" type="object"
                            class="btn-success"
                            invisible="state != 'confirmed'" />
                        <button name="action_mark_as_eod" string="Mark as End of Day" type="object"
                            class="btn-warning"
                            invisible="audit_type != 'close_shift' or state != 'draft'" />
                        <button name="action_reset_draft" string="Reset to Draft" type="object"
                            invisible="state == 'draft'" />
                        <field name="state" widget="statusbar"
                            statusbar_visible="draft,confirmed,reconciled" />
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button class="oe_stat_button" icon="fa-list-alt"
                                name="%(action_gas_station_shift_audit_deposits)d"
                                type="action">
                                <field name="total_deposit_count" widget="statinfo" string="Deposits"/>
                            </button>
                            <button class="oe_stat_button" icon="fa-clock-o"
                                name="%(action_gas_station_shift_audit_shifts)d"
                                type="action"
                                invisible="audit_type != 'end_of_day'">
                                <field name="shift_count_in_period" widget="statinfo" string="Shifts"/>
                            </button>
                        </div>
                        
                        <!-- Ribbons - EOD ‡∏à‡∏∞‡∏°‡∏µ ribbon ‡∏™‡∏µ‡∏™‡πâ‡∏° -->
                        <widget name="web_ribbon" title="üåô END OF DAY" bg_color="text-bg-warning"
                            invisible="audit_type != 'end_of_day'" />
                        <widget name="web_ribbon" title="Discrepancy" bg_color="text-bg-danger"
                            invisible="state != 'discrepancy'" />
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1" />
                            </h1>
                            <h3 class="text-muted">
                                <span invisible="audit_type != 'close_shift'">
                                    Shift #<field name="shift_number" readonly="1" class="oe_inline"/>
                                </span>
                                <span invisible="audit_type != 'end_of_day'" class="text-warning fw-bold">
                                    üåô Last Shift of Day (End of Day)
                                </span>
                            </h3>
                        </div>
                        
                        <group>
                            <group string="Basic Info">
                                <field name="audit_type" />
                                <field name="is_last_shift" />
                                <field name="shift_number" />
                                <field name="staff_id" />
                                <field name="staff_external_id" />
                                <field name="staff_name" />
                                <field name="pos_terminal_id" />
                                <field name="pos_shift_id" />
                            </group>
                            <group string="Time Period">
                                <field name="shift_start_time" />
                                <field name="close_time" />
                                <field name="period_start" />
                                <field name="period_end" />
                                <field name="previous_eod_id" />
                                <field name="parent_eod_id" 
                                    invisible="audit_type == 'end_of_day'" />
                            </group>
                        </group>
                        
                        <notebook>
                            <!-- This Shift Summary Tab -->
                            <page string="This Shift" name="shift_summary">
                                <group string="POS Totals (‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ POS - Shift ‡∏ô‡∏µ‡πâ)">
                                    <group>
                                        <field name="pos_oil_total" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="pos_engine_oil_total" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="pos_other_total" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                    <group>
                                        <field name="pos_total_amount" widget="monetary"
                                            options="{'currency_field': 'currency_id'}"
                                            class="oe_subtotal_footer_separator" />
                                        <field name="pos_transaction_count" />
                                    </group>
                                </group>
                                
                                <group string="Deposit Totals by Type (‡∏¢‡∏≠‡∏î Shift ‡∏ô‡∏µ‡πâ)">
                                    <group>
                                        <field name="total_oil" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_engine_oil" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_coffee_shop" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_convenient_store" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                    <group>
                                        <field name="total_rental" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_deposit_cash" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_exchange_cash" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="total_other" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                </group>
                                <group>
                                    <group>
                                        <field name="total_all_deposits" widget="monetary"
                                            options="{'currency_field': 'currency_id'}"
                                            class="oe_subtotal_footer_separator" />
                                    </group>
                                </group>
                            </page>
                            
                            <!-- EOD Summary Tab (End of Day only) - ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô -->
                            <page string="üåô Day Summary" name="eod_summary"
                                invisible="audit_type != 'end_of_day'">
                                <div class="alert alert-warning" role="alert">
                                    <strong>üåô End of Day Summary</strong> - ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà End of Day ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å Shift ‡πÉ‡∏ô Period ‡∏ô‡∏µ‡πâ)
                                </div>
                                <group string="EOD Totals (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)">
                                    <group>
                                        <field name="eod_total_oil" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_engine_oil" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_coffee_shop" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_convenient_store" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                    <group>
                                        <field name="eod_total_rental" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_deposit_cash" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_exchange_cash" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="eod_total_other" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                </group>
                                <group>
                                    <group>
                                        <field name="eod_grand_total" widget="monetary"
                                            options="{'currency_field': 'currency_id'}"
                                            class="oe_subtotal_footer_separator text-warning fw-bold" />
                                        <field name="eod_pos_total" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                </group>
                                
                                <separator string="Shifts in This Period" />
                                <field name="shift_audit_ids" nolabel="1" readonly="1">
                                    <tree decoration-info="True">
                                        <field name="shift_number" string="#" />
                                        <field name="name" />
                                        <field name="close_time" />
                                        <field name="staff_external_id" />
                                        <field name="total_all_deposits" widget="monetary" sum="Total" />
                                        <field name="pos_total_amount" widget="monetary" sum="POS Total" />
                                        <field name="state" widget="badge" />
                                        <field name="currency_id" column_invisible="1" />
                                    </tree>
                                </field>
                            </page>
                            
                            <!-- Collection Box Tab (End of Day only) -->
                            <page string="üí∞ Collection Box" name="collection"
                                invisible="audit_type != 'end_of_day'">
                                <div class="alert alert-info" role="alert">
                                    <strong>üí∞ Collection Summary</strong> - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å Glory Machine
                                </div>
                                <group string="Collection Summary">
                                    <group>
                                        <field name="collected_amount" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                        <field name="reserve_kept" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" />
                                    </group>
                                    <group>
                                        <field name="collection_expected" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" readonly="1" />
                                        <field name="collection_difference" widget="monetary"
                                            options="{'currency_field': 'currency_id'}" readonly="1"
                                            decoration-danger="collection_difference != 0"
                                            decoration-success="collection_difference == 0" />
                                    </group>
                                </group>
                                <group string="Collection Breakdown" colspan="2"
                                    invisible="not collection_breakdown">
                                    <field name="collection_breakdown" nolabel="1" widget="text"
                                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏ô‡∏ö‡∏±‡∏ï‡∏£/‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç..." readonly="1" />
                                </group>
                            </page>
                            
                            <!-- Related Deposits Tab -->
                            <page string="Deposits" name="deposits">
                                <field name="deposit_ids" nolabel="1">
                                    <tree>
                                        <field name="name" />
                                        <field name="date" />
                                        <field name="deposit_type" />
                                        <field name="total_amount" widget="monetary" sum="Total" />
                                        <field name="state" widget="badge" />
                                    </tree>
                                </field>
                            </page>
                            
                            <!-- Notes Tab -->
                            <page string="Notes" name="notes">
                                <group>
                                    <field name="notes" placeholder="General notes..." />
                                </group>
                                <group>
                                    <field name="reconciliation_notes" placeholder="Reconciliation notes..." />
                                </group>
                            </page>
                        </notebook>
                        
                        <group>
                            <field name="currency_id" invisible="1" />
                            <field name="company_id" groups="base.group_multi_company" />
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" />
                        <field name="activity_ids" />
                        <field name="message_ids" />
                    </div>
                </form>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- SEARCH VIEW -->
        <!-- ================================================================== -->

        <record id="view_gas_station_shift_audit_search" model="ir.ui.view">
            <field name="name">gas.station.shift.audit.search</field>
            <field name="model">gas.station.shift.audit</field>
            <field name="arch" type="xml">
                <search string="Search Shift Audits">
                    <field name="name" />
                    <field name="staff_external_id" />
                    <field name="pos_terminal_id" />
                    <field name="shift_number" />
                    <separator />
                    <filter string="Today" name="filter_today"
                        domain="[('close_time', '>=', context_today().strftime('%Y-%m-%d'))]" />
                    <filter string="This Week" name="filter_week"
                        domain="[('close_time', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]" />
                    <separator />
                    <filter string="Close Shift" name="filter_close_shift"
                        domain="[('audit_type', '=', 'close_shift')]" />
                    <filter string="üåô End of Day" name="filter_end_of_day"
                        domain="[('audit_type', '=', 'end_of_day')]" />
                    <separator />
                    <filter string="Draft" name="filter_draft"
                        domain="[('state', '=', 'draft')]" />
                    <filter string="Confirmed" name="filter_confirmed"
                        domain="[('state', '=', 'confirmed')]" />
                    <filter string="Reconciled" name="filter_reconciled"
                        domain="[('state', '=', 'reconciled')]" />
                    <filter string="‚ö†Ô∏è Discrepancy" name="filter_discrepancy"
                        domain="[('state', '=', 'discrepancy')]" />
                    <group expand="0" string="Group By">
                        <filter string="Audit Type" name="group_type"
                            context="{'group_by': 'audit_type'}" />
                        <filter string="Staff" name="group_staff"
                            context="{'group_by': 'staff_external_id'}" />
                        <filter string="Date" name="group_date"
                            context="{'group_by': 'close_time:day'}" />
                        <filter string="State" name="group_state"
                            context="{'group_by': 'state'}" />
                    </group>
                </search>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- PIVOT VIEW -->
        <!-- ================================================================== -->

        <record id="view_gas_station_shift_audit_pivot" model="ir.ui.view">
            <field name="name">gas.station.shift.audit.pivot</field>
            <field name="model">gas.station.shift.audit</field>
            <field name="arch" type="xml">
                <pivot string="Shift Audit Analysis">
                    <field name="close_time" type="row" interval="day" />
                    <field name="audit_type" type="col" />
                    <field name="total_all_deposits" type="measure" />
                    <field name="pos_total_amount" type="measure" />
                    <field name="collected_amount" type="measure" />
                </pivot>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- GRAPH VIEW -->
        <!-- ================================================================== -->

        <record id="view_gas_station_shift_audit_graph" model="ir.ui.view">
            <field name="name">gas.station.shift.audit.graph</field>
            <field name="model">gas.station.shift.audit</field>
            <field name="arch" type="xml">
                <graph string="Shift Audit Analysis" type="bar">
                    <field name="close_time" interval="day" />
                    <field name="total_all_deposits" type="measure" />
                    <field name="pos_total_amount" type="measure" />
                </graph>
            </field>
        </record>

        <!-- ================================================================== -->
        <!-- MENU -->
        <!-- ================================================================== -->

        <menuitem id="menu_gas_station_shift_audit"
            name="Shift Audits"
            parent="menu_gas_station_cash_root"
            action="action_gas_station_shift_audit"
            sequence="30" />

    </data>
</odoo>