<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve" xmlns:t="http://odoo.com/owl">

<t t-name="gas_station_cash.WithdrawalScreen" owl="1">
    <div class="withdrawal-screen">

        <!-- Step 1: Enter Amount -->
        <t t-if="state.step === 'amount'">
            <div class="withdrawal-card withdrawal-card-wide">
                <div class="withdrawal-two-col">

                    <!-- ===== LEFT: Header + Fixed Breakdown Panel ===== -->
                    <div class="withdrawal-info-panel">

                        <!-- Header -->
                        <div class="withdrawal-header">
                            <div class="withdrawal-icon">
                                <i class="fa fa-money"></i>
                            </div>
                            <h2 class="withdrawal-title">Withdrawal</h2>
                            <p class="withdrawal-subtitle">ถอนเงิน</p>
                        </div>

                        <!--
                            Always renders all denomination slots (Notes: 1000,500,100,50,20 | Coins: 10,5,2,1).
                            Slots with qty=0 are shown as inactive, preventing any layout shift.
                        -->
                        <div class="withdrawal-breakdown-panel">
                            <div class="breakdown-label">Breakdown / รายละเอียด:</div>

                            <!-- Notes: fixed slots 1000, 500, 100, 50, 20 -->
                            <div class="breakdown-section-title">
                                <i class="fa fa-money"></i> Notes / ธนบัตร
                            </div>
                            <div class="breakdown-fixed-grid">
                                <t t-foreach="[1000, 500, 100, 50, 20]" t-as="denom" t-key="denom">
                                    <t t-set="noteItem" t-value="state.breakdown.notes.find(n => n.value === denom)"/>
                                    <div t-att-class="'breakdown-fixed-slot' + (noteItem and noteItem.qty > 0 ? ' active' : '')">
                                        <span class="bfs-denom">฿<t t-esc="denom.toLocaleString()"/></span>
                                        <span class="bfs-qty">× <t t-esc="noteItem ? noteItem.qty : 0"/></span>
                                        <span class="bfs-total">฿<t t-esc="noteItem ? noteItem.amount.toLocaleString() : '0'"/></span>
                                    </div>
                                </t>
                            </div>

                            <!-- Coins: fixed slots 10, 5, 2, 1 -->
                            <div class="breakdown-section-title" style="margin-top: 0.625rem;">
                                <i class="fa fa-circle-o"></i> Coins / เหรียญ
                            </div>
                            <div class="breakdown-fixed-grid">
                                <t t-foreach="[10, 5, 2, 1]" t-as="denom" t-key="denom">
                                    <t t-set="coinItem" t-value="state.breakdown.coins.find(c => c.value === denom)"/>
                                    <div t-att-class="'breakdown-fixed-slot' + (coinItem and coinItem.qty > 0 ? ' active' : '')">
                                        <span class="bfs-denom">฿<t t-esc="denom"/></span>
                                        <span class="bfs-qty">× <t t-esc="coinItem ? coinItem.qty : 0"/></span>
                                        <span class="bfs-total">฿<t t-esc="coinItem ? coinItem.amount.toLocaleString() : '0'"/></span>
                                    </div>
                                </t>
                            </div>

                            <!-- Grand Total -->
                            <div class="breakdown-total-row">
                                <span>Total / รวม</span>
                                <span class="breakdown-grand-total">฿<t t-esc="state.breakdown.total.toLocaleString()"/></span>
                            </div>
                        </div>

                    </div>

                    <!-- ===== RIGHT: Staff + Amount + Available + Keypad (fixed position, does not shift) ===== -->
                    <div class="withdrawal-keypad-panel">

                        <!-- Staff Info -->
                        <div class="withdrawal-staff-info">
                            <i class="fa fa-user"></i>
                            <span><t t-esc="staffName"/></span>
                        </div>

                        <!-- Status Bar — always visible to prevent layout shift.
                             Shows green "Ready" when no error, red message when validation fails. -->
                        <div t-att-class="'withdrawal-status-bar' + (state.error ? ' is-error' : ' is-ready')">
                            <t t-if="state.error">
                                <i class="fa fa-exclamation-circle"></i>
                                <span><t t-esc="state.error"/></span>
                            </t>
                            <t t-else="">
                                <i class="fa fa-check-circle"></i>
                                <span>Ready</span>
                            </t>
                        </div>

                        <!-- Amount Display -->
                        <div class="withdrawal-amount-display">
                            <span class="withdrawal-currency">฿</span>
                            <span class="withdrawal-amount-value"><t t-esc="displayAmount"/></span>
                        </div>

                        <!-- Available Balance -->
                        <div class="withdrawal-available">
                            <t t-if="state.inventoryLoading">
                                <i class="fa fa-spinner fa-spin"></i>
                                <span>Loading availability...</span>
                            </t>
                            <t t-else="">
                                <span>Available / ถอนได้สูงสุด:</span>
                                <strong>฿<t t-esc="state.maxWithdrawable.toLocaleString()"/></strong>
                            </t>
                        </div>

                        <!-- Numeric Keypad -->
                        <div class="withdrawal-keypad">
                            <t t-foreach="[1,2,3,4,5,6,7,8,9]" t-as="digit" t-key="digit">
                                <button class="keypad-btn" t-on-click="() => this._onKeypadPress(digit)">
                                    <t t-esc="digit"/>
                                </button>
                            </t>
                            <button class="keypad-btn keypad-clear" t-on-click="_onClear">C</button>
                            <button class="keypad-btn" t-on-click="() => this._onKeypadPress(0)">0</button>
                            <button class="keypad-btn keypad-backspace" t-on-click="_onBackspace">
                                <i class="fa fa-arrow-left"></i>
                            </button>
                        </div>

                        <!-- Sub-Baht Row: .25 / .50 / .75 -->
                        <div class="withdrawal-subbaht-row">
                            <button t-att-class="'keypad-btn keypad-subbaht' + (state.subBahtSatang === 25 ? ' is-active' : '')"
                                    t-on-click="() => this._onSubBahtPress(25)">.25</button>
                            <button t-att-class="'keypad-btn keypad-subbaht' + (state.subBahtSatang === 50 ? ' is-active' : '')"
                                    t-on-click="() => this._onSubBahtPress(50)">.50</button>
                            <button t-att-class="'keypad-btn keypad-subbaht' + (state.subBahtSatang === 75 ? ' is-active' : '')"
                                    t-on-click="() => this._onSubBahtPress(75)">.75</button>
                        </div>

                        <!-- Action Buttons -->
                        <div class="withdrawal-actions">
                            <button class="withdrawal-btn withdrawal-btn-confirm"
                                    t-att-disabled="!canConfirm"
                                    t-on-click="_onProceedToConfirm">
                                <i class="fa fa-arrow-right me-2"></i>
                                Next / ถัดไป
                            </button>
                            <button class="withdrawal-btn withdrawal-btn-cancel"
                                    t-on-click="_onCancel">
                                Cancel / ยกเลิก
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </t>

        <!-- Step 2: Confirm -->
        <t t-if="state.step === 'confirm'">
            <div class="withdrawal-card">
                <div class="withdrawal-header">
                    <div class="withdrawal-icon confirm">
                        <i class="fa fa-check-circle"></i>
                    </div>
                    <h2 class="withdrawal-title">Confirm Withdrawal</h2>
                    <p class="withdrawal-subtitle">ยืนยันการถอนเงิน</p>
                </div>

                <!-- Amount -->
                <div class="withdrawal-confirm-amount">
                    <span class="confirm-label">Amount / จำนวนเงิน</span>
                    <span class="confirm-value">฿<t t-esc="state.breakdown.total.toLocaleString()"/></span>
                </div>

                <!-- Breakdown Details -->
                <div class="withdrawal-confirm-breakdown">
                    <div class="confirm-section" t-if="state.breakdown.notes.length > 0">
                        <div class="confirm-section-title">
                            <i class="fa fa-money"></i> Notes / ธนบัตร
                        </div>
                        <div class="confirm-items">
                            <t t-foreach="state.breakdown.notes" t-as="note" t-key="note.value">
                                <div class="confirm-item">
                                    <span class="item-denom">฿<t t-esc="note.value.toLocaleString()"/></span>
                                    <span class="item-qty">× <t t-esc="note.qty"/></span>
                                    <span class="item-total">= ฿<t t-esc="note.amount.toLocaleString()"/></span>
                                </div>
                            </t>
                        </div>
                    </div>

                    <div class="confirm-section" t-if="state.breakdown.coins.length > 0">
                        <div class="confirm-section-title">
                            <i class="fa fa-circle"></i> Coins / เหรียญ
                        </div>
                        <div class="confirm-items">
                            <t t-foreach="state.breakdown.coins" t-as="coin" t-key="coin.value">
                                <div class="confirm-item">
                                    <span class="item-denom">฿<t t-esc="coin.value"/></span>
                                    <span class="item-qty">× <t t-esc="coin.qty"/></span>
                                    <span class="item-total">= ฿<t t-esc="coin.amount.toLocaleString()"/></span>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>

                <!-- Staff Info -->
                <div class="withdrawal-confirm-staff">
                    <i class="fa fa-user"></i>
                    <span>Staff: <t t-esc="staffName"/></span>
                </div>

                <!-- Error -->
                <div class="withdrawal-error" t-if="state.error">
                    <i class="fa fa-exclamation-circle"></i>
                    <span><t t-esc="state.error"/></span>
                </div>

                <!-- Action Buttons -->
                <div class="withdrawal-actions">
                    <button class="withdrawal-btn withdrawal-btn-confirm"
                            t-att-disabled="state.busy"
                            t-on-click="_onConfirmDispense">
                        <i class="fa fa-check me-2"></i>
                        Confirm / ยืนยัน
                    </button>
                    <button class="withdrawal-btn withdrawal-btn-back"
                            t-att-disabled="state.busy"
                            t-on-click="_onBackToAmount">
                        <i class="fa fa-arrow-left me-2"></i>
                        Back / กลับ
                    </button>
                </div>
            </div>
        </t>

        <!-- Step 3: Dispensing -->
        <t t-if="state.step === 'dispensing'">
            <div class="withdrawal-card">
                <div class="withdrawal-header">
                    <div class="withdrawal-icon dispensing">
                        <i class="fa fa-spinner fa-spin"></i>
                    </div>
                    <h2 class="withdrawal-title">Dispensing...</h2>
                    <p class="withdrawal-subtitle">กำลังจ่ายเงิน กรุณารอสักครู่</p>
                </div>

                <div class="withdrawal-dispensing-amount">
                    <span class="dispensing-currency">฿</span>
                    <span class="dispensing-value"><t t-esc="state.breakdown.total.toLocaleString()"/></span>
                </div>

                <div class="withdrawal-dispensing-notice">
                    <i class="fa fa-hand-paper-o"></i>
                    <span>Please wait for cash to be dispensed</span>
                </div>
            </div>
        </t>

        <!-- Step 3.5: Waiting for Pickup -->
        <t t-if="state.step === 'pickup'">
            <div class="withdrawal-card">
                <div class="withdrawal-header">
                    <div class="withdrawal-icon pickup" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <i class="fa fa-hand-grab-o"></i>
                    </div>
                    <h2 class="withdrawal-title">Collect Your Cash</h2>
                    <p class="withdrawal-subtitle">กรุณาหยิบเงินออกจากเครื่อง</p>
                </div>

                <!-- Withdrawal Image -->
                <div class="withdrawal-pickup-image" style="text-align: center; margin: 16px 0;">
                    <img src="/gas_station_cash/static/img/withdrawal.png"
                         alt="Collect cash"
                         style="max-width: 100%; max-height: 200px; border-radius: 12px;"/>
                </div>

                <div class="withdrawal-dispensing-amount">
                    <span class="dispensing-currency">฿</span>
                    <span class="dispensing-value"><t t-esc="state.dispensedAmount.toLocaleString()"/></span>
                </div>

                <div class="withdrawal-pickup-notice" style="text-align: center; padding: 24px; background: #fff3cd; border-radius: 12px; margin: 16px 0;">
                    <i class="fa fa-arrow-down fa-2x" style="color: #f39c12; margin-bottom: 12px; display: block;"></i>
                    <p style="font-size: 1.1rem; margin: 8px 0;">Please collect all cash from the dispenser</p>
                    <p style="color: #666;">กรุณาหยิบเงินทั้งหมดออกจากช่องจ่ายเงิน</p>
                </div>

                <div class="withdrawal-waiting" style="text-align: center; color: #888; margin-top: 16px;">
                    <i class="fa fa-spinner fa-spin"></i>
                    <span style="margin-left: 8px;">Waiting for cash to be collected...</span>
                </div>
            </div>
        </t>

        <!-- Step 4: Done -->
        <t t-if="state.step === 'done'">
            <div class="withdrawal-card">
                <div class="withdrawal-header">
                    <div class="withdrawal-icon success">
                        <i class="fa fa-check"></i>
                    </div>
                    <h2 class="withdrawal-title">Withdrawal Complete!</h2>
                    <p class="withdrawal-subtitle">ถอนเงินสำเร็จ</p>
                </div>

                <div class="withdrawal-done-amount">
                    <span class="done-label">Dispensed / จ่ายเงินแล้ว</span>
                    <span class="done-value">฿<t t-esc="state.dispensedAmount.toLocaleString()"/></span>
                </div>

                <div class="withdrawal-done-notice" style="text-align: center; margin-top: 24px; color: #666;">
                    <i class="fa fa-home" style="margin-right: 8px;"></i>
                    <span>Returning to home in 3 seconds...</span>
                    <p style="margin-top: 8px;">กลับไปหน้าหลักใน 3 วินาที...</p>
                </div>
            </div>
        </t>

    </div>
</t>

</templates>